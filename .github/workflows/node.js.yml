name: Deploy Backend to VPS

on:
  push:
    branches: ["main"]


jobs:
  build:
    runs-on: self-hosted
    
    strategy:
      matrix:
        node-version: [22.x]
    
    steps:
      # Step 1: Check out the repository
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # Step 2: ğŸ” CREATE .env FILE FROM GITHUB SECRETS (THE MAGIC!)
      - name: ğŸ” Create .env file from GitHub Secrets
        run: |
          cd ${{ github.workspace }}/backend
          cat << 'EOF' > .env
          echo ${{ secrets.BACKEND_ENV }} 
          EOF

          cat << 'EOF' >> .env
          ${{ secrets.BACKEND_EMAIL }}
          EOF

          cat << 'EOF' >> .env
          ${{ secrets.BACKEND_STRIPE }}
          EOF

          cat << 'EOF' >> .env
          ${{ secrets.BACKEND_AWS }}
          EOF

          cat << 'EOF' >> .env
          ${{ secrets.BACKEND_JWT }}
          EOF


          chmod 600 .env
          # Verify it's not empty
          if [ ! -s .env ]; then
            echo "âŒ ERROR: .env file is empty!"
            exit 1
          fi
          echo "âœ… .env created with $(wc -l < .env) lines"
      
      # Step 3: Install Bun
      - name: ğŸ”§ Install Bun
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          if ! command -v bun &> /dev/null; then
            echo "ğŸ“¦ Installing Bun..."
            curl -fsSL https://bun.sh/install | bash
            export PATH="$HOME/.bun/bin:$PATH"
          fi
          bun --version
      
      # Step 4: Install dependencies
      - name: ğŸ“¦ Install dependencies with Bun
        run: |
          cd ${{ github.workspace }}/backend
          export PATH="$HOME/.bun/bin:$PATH"
          bun install
      
      # # Step 5: Build the project
      # - name: ğŸ—ï¸ Build the project
      #   run: |
      #     cd ${{ github.workspace }}/backend
      #     export PATH="$HOME/.bun/bin:$PATH"
      #     bun run typecheck
      #     echo "âœ… Build completed successfully!"
      
      # Step 6: Restart the application
      - name: ğŸš€ Restart Application
        run: |
          cd ${{ github.workspace }}/backend
          pm2 delete backend || true
          pm2 start src/server.ts --name backend --interpreter bun
          pm2 save
          echo "âœ… Backend deployment completed successfully!"
