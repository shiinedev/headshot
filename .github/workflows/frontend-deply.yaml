name: Deploy VPS

on:
  push:
    branches:
      - main
      

jobs:
  deploy:
    runs-on: self-hosted
    
    
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîê Create .env file
        run: |
          cd ${{ github.workspace }}/frontend
          cat << 'EOF' > .env
          echo ${{ secrets.BACKEND_ENV }} 
          EOF
          chmod 600 .env
          echo "‚úÖ . frontend env created with $(wc -l < .env) lines"
          cd ${{ github.workspace }}/backend
          cat << 'EOF' > .env
          echo ${{ secrets.BACKEND_ENV }} 
          EOF

          cat << 'EOF' >> .env
          ${{ secrets.BACKEND_EMAIL }}
          EOF

          cat << 'EOF' >> .env
          ${{ secrets.BACKEND_STRIPE }}
          EOF

          cat << 'EOF' >> .env
          ${{ secrets.BACKEND_AWS }}
          EOF

          cat << 'EOF' >> .env
          ${{ secrets.BACKEND_JWT }}
          EOF


          chmod 600 .env
          # Verify it's not empty
          if [ ! -s .env ]; then
            echo "‚ùå ERROR: .env file is empty!"
            exit 1
          fi
          echo "‚úÖ .backend env created with $(wc -l < .env) lines"
          echo "‚úÖ .env created"
      
      - name: üîß Setup Bun
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          bun --version || curl -fsSL https://bun.sh/install | bash
      
      - name: üì¶ Install dependencies
        run: |
          cd ${{ github.workspace }}/frontend
          export PATH="$HOME/.bun/bin:$PATH"
          bun install
          cd ${{ github.workspace }}/backend
          export PATH="$HOME/.bun/bin:$PATH"
          bun install 
          echo "‚úÖ Dependencies installed successfully!"
      
      - name: üèóÔ∏è Build project
        run: |
          cd ${{ github.workspace }}/frontend
          export PATH="$HOME/.bun/bin:$PATH"
          bun run build

      
      - name: üîç Verify build
        run: |
          cd ${{ github.workspace }}/frontend
          if [ -d ".next" ]; then
            echo "‚úÖ Build successful!"
            echo "Contents of .next folder:"
            ls -lah .next/
            echo ""
            echo "Server folder:"
            ls -lah .next/server/ 2>/dev/null || echo "No server folder"
          else
            echo "‚ùå Build failed - .next folder not found"
            exit 1
            fi
      
      - name: üöÄ Restart PM2
        run: |
          cd ${{ github.workspace }}/frontend
          export PATH="$HOME/.bun/bin:$PATH"
          pm2 restart frontend || pm2 start bun --name frontend -- run start
          cd ${{ github.workspace }}/backend
          pm2 stop backend || true  
          pm2 start src/server.ts --name backend --interpreter bun
          pm2 save