name: Deploy Frontend to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    
    defaults:
      run:
        working-directory: frontend
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Create .env file
        run: |
          echo "${{ secrets.FRONTEND_ENV }}" > .env
          chmod 600 .env
          echo "âœ… .env created"
      
      - name: ğŸ”§ Setup Bun
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          bun --version || curl -fsSL https://bun.sh/install | bash
      
      - name: ğŸ“¦ Install dependencies
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          bun install
      
      - name: ğŸ—ï¸ Build project
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          bun run build

      
      - name: ğŸ” Verify build
        run: |
          if [ -d ".next" ]; then
            echo "âœ… Build successful!"
            echo "Contents of .next folder:"
            ls -lah .next/
            echo ""
            echo "Server folder:"
            ls -lah .next/server/ 2>/dev/null || echo "No server folder"
          else
            echo "âŒ Build failed - .next folder not found"
            exit 1
            fi
      
      - name: ğŸš€ Restart PM2
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          pm2 restart frontend || pm2 start bun --name frontend -- run start
          pm2 save