name: Deploy Frontend to VPS

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: self-hosted
    
    strategy:
      matrix:
        node-version: [22.x]
    
    steps:
      # Step 1: Check out the repository
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # Step 2: ğŸ” CREATE .env FILE FROM GITHUB SECRETS
      - name: ğŸ” Create .env file from GitHub Secrets
        working-directory: ./frontend
        run: |
          echo "${{ secrets.FRONTEND_ENV }}" > .env
          chmod 600 .env
          echo "âœ… .env file created successfully"
      
      # Step 3: Install Bun
      - name: ğŸ”§ Setup Bun
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          if ! command -v bun &> /dev/null; then
            echo "ğŸ“¦ Installing Bun..."
            curl -fsSL https://bun.sh/install | bash
          fi
          bun --version
      
      # Step 4: Install dependencies
      - name: ğŸ“¦ Install dependencies with Bun
        working-directory: ./frontend
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          bun install
      
      # Step 5: Build the project
      - name: ğŸ—ï¸ Build the project
        working-directory: ./frontend
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          bun run build
      
      # Step 6: Verify build output
      - name: ğŸ” Verify .next folder
        working-directory: ./frontend
        run: |
          if [ -d ".next" ]; then
            echo "âœ… .next folder exists"
            ls -la .next/
          else
            echo "âŒ .next folder not found!"
            exit 1
          fi
      
      # Step 7: Restart the application
      - name: ğŸš€ Restart Application
        working-directory: ./frontend
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          pm2 restart frontend || pm2 start bun --name frontend -- run start
          pm2 save
          echo "âœ… Frontend deployment completed successfully!"